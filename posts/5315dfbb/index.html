<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>自建busuanzi网站计数服务 | yww</title><meta name="author" content="yww"><meta name="copyright" content="yww"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="前言 不蒜子(busuanzi) 是一个广受欢迎的免费网页计数服务，能够轻松实现网站的页面浏览量(PV)和独立访客数(UV)统计。许多基于Hexo的网站都在使用busuanzi来实现访问统计功能，我的博客当前使用的主题是Butterfly，这个主题也是通过集成busuanzi计数器来实现网页计数。 然而，随着使用人数的不断增多，这个由作者为爱发电的免费服务开始出现稳定性问题，访问速度也变得起伏不定"><meta property="og:type" content="article"><meta property="og:title" content="自建busuanzi网站计数服务"><meta property="og:url" content="https://yww52.com/posts/5315dfbb/index.html"><meta property="og:site_name" content="yww"><meta property="og:description" content="前言 不蒜子(busuanzi) 是一个广受欢迎的免费网页计数服务，能够轻松实现网站的页面浏览量(PV)和独立访客数(UV)统计。许多基于Hexo的网站都在使用busuanzi来实现访问统计功能，我的博客当前使用的主题是Butterfly，这个主题也是通过集成busuanzi计数器来实现网页计数。 然而，随着使用人数的不断增多，这个由作者为爱发电的免费服务开始出现稳定性问题，访问速度也变得起伏不定"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://img.yww52.com/2025/8/2025-8-10top_img.jpg"><meta property="article:published_time" content="2025-08-09T16:00:00.000Z"><meta property="article:modified_time" content="2025-08-11T09:56:10.264Z"><meta property="article:author" content="yww"><meta property="article:tag" content="yw,yww"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://img.yww52.com/2025/8/2025-8-10top_img.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "自建busuanzi网站计数服务",
  "url": "https://yww52.com/posts/5315dfbb/",
  "image": "https://img.yww52.com/2025/8/2025-8-10top_img.jpg",
  "datePublished": "2025-08-09T16:00:00.000Z",
  "dateModified": "2025-08-11T09:56:10.264Z",
  "author": [
    {
      "@type": "Person",
      "name": "yww",
      "url": "https://yww52.com"
    }
  ]
}</script><link rel="shortcut icon" href="/yww/favicon.jpeg"><link rel="canonical" href="https://yww52.com/posts/5315dfbb/index.html"><link rel="preconnect" href="//cdnjs.cloudflare.com"><link rel="preconnect" href="//hm.baidu.com"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/node-snackbar/0.1.16/snackbar.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/6.0.7/fancybox/fancybox.min.css" media="print" onload='this.media="all"'><script>(()=>{var e={set:(e,t,a)=>{a&&(a=Date.now()+864e5*a,localStorage.setItem(e,JSON.stringify({value:t,expiry:a})))},get:e=>{var t=localStorage.getItem(e);if(t){var{value:t,expiry:a}=JSON.parse(t);if(!(Date.now()>a))return t;localStorage.removeItem(e)}}},t=(window.btf={saveToLocal:e,getScript:(o,n={})=>new Promise((e,t)=>{let a=document.createElement("script");a.src=o,a.async=!0,Object.entries(n).forEach(([e,t])=>a.setAttribute(e,t)),a.onload=a.onreadystatechange=()=>{a.readyState&&!/loaded|complete/.test(a.readyState)||e()},a.onerror=t,document.head.appendChild(a)}),getCSS:(o,n)=>new Promise((e,t)=>{let a=document.createElement("link");a.rel="stylesheet",a.href=o,n&&(a.id=n),a.onload=a.onreadystatechange=()=>{a.readyState&&!/loaded|complete/.test(a.readyState)||e()},a.onerror=t,document.head.appendChild(a)}),addGlobalFn:(e,t,a=!1,o=window)=>{var n=o.globalFn||{};n[e]=n[e]||{},n[e][a||Object.keys(n[e]).length]=t,o.globalFn=n}},()=>{document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")}),a=()=>{document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","ffffff")},o=(btf.activateDarkMode=t,btf.activateLightMode=a,e.get("theme")),t=("dark"===o?t():"light"===o&&a(),e.get("aside-status"));void 0!==t&&document.documentElement.classList.toggle("hide-aside","hide"===t);/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})()</script><script>var _hmt=_hmt||[];(()=>{var e=document.createElement("script"),t=(e.src="https://hm.baidu.com/hm.js?136a6aeed7736be835cf2e59b702bfd6",document.getElementsByTagName("script")[0]);t.parentNode.insertBefore(e,t)})(),btf.addGlobalFn("pjaxComplete",()=>{_hmt.push(["_trackPageview",window.location.pathname])},"baidu_analytics")</script><script>let GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"/search.xml",preload:!0,top_n_per_article:1,unescape:!1,languages:{hits_empty:"未找到符合您查询的内容：${query}",hits_stats:"共找到 ${hits} 篇文章"}},translate:void 0,highlight:{plugin:"highlight.js",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:300,highlightFullpage:!1,highlightMacStyle:!0},copy:{success:"复制成功",error:"复制失败",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,post:!1},runtime:"天",dateSuffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:void 0,lightbox:"fancybox",Snackbar:{chs_to_cht:"已切换为繁体中文",cht_to_chs:"已切换为简体中文",day_to_night:"已切换为深色模式",night_to_day:"已切换为浅色模式",bgLight:"#8EC5FC",bgDark:"#1f1f1f",position:"top-center"},infinitegrid:{js:"https://cdnjs.cloudflare.com/ajax/libs/egjs-infinitegrid/4.12.0/infinitegrid.min.js",buttonText:"加载更多"},isPhotoFigcaption:!0,islazyloadPlugin:!0,isAnchor:!1,percent:{toc:!0,rightside:!0},autoDarkmode:!1}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"自建busuanzi网站计数服务",isHighlightShrink:!1,isToc:!0,pageType:"post"}</script><script data-pjax charset="UTF-8" id="LA_COLLECT" src="https://img.yww52.com/source/scripts/js-sdk-pro.min.js"></script><script data-pjax>LA.init({id:"3H0GBfojNsZxwWln",ck:"3H0GBfojNsZxwWln"})</script><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="yww" type="application/atom+xml"></head><body><div id="web_bg" style="background-color:#efefef"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src= "https://img.yww52.com/source/image/404.jpg" data-lazy-src="https://img.yww52.com/avatar.jpg" onerror='this.onerror=null,this.src="/yww/loading.gif"' alt="avatar"></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">73</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">17</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw iconfont icon-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw iconfont icon-archives"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw iconfont icon-categories"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw iconfont icon-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/comment/"><i class="fa-fw iconfont icon-comment"></i><span> 留言页</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw iconfont icon-about"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(https://img.yww52.com/2025/8/2025-8-10top_img.jpg)"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">yww</span></a><a class="nav-page-title" href="/"><span class="site-name">自建busuanzi网站计数服务</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span> 返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw iconfont icon-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw iconfont icon-archives"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw iconfont icon-categories"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw iconfont icon-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/comment/"><i class="fa-fw iconfont icon-comment"></i><span> 留言页</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw iconfont icon-about"></i><span> 关于</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">自建busuanzi网站计数服务</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-08-09T16:00:00.000Z" title="发表于 2025-08-10 00:00:00">2025-08-10</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-08-11T09:56:10.264Z" title="更新于 2025-08-11 17:56:10">2025-08-11</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%9C%8D%E5%8A%A1%E6%90%AD%E5%BB%BA/">服务搭建</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">4.7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>19分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://busuanzi.ibruce.info/">不蒜子(busuanzi)</a> 是一个广受欢迎的免费网页计数服务，能够轻松实现网站的页面浏览量(PV)和独立访客数(UV)统计。许多基于Hexo的网站都在使用busuanzi来实现访问统计功能，我的博客当前使用的主题是<code>Butterfly</code>，这个主题也是通过集成busuanzi计数器来实现网页计数。</p><p>然而，随着使用人数的不断增多，这个由作者为爱发电的免费服务开始出现稳定性问题，访问速度也变得起伏不定。</p><p>因此，我决定自己开发一个服务来代替busuanzi，为我的网站提供稳定的计数服务。</p><h1 id="技术栈选择"><a href="#技术栈选择" class="headerlink" title="技术栈选择"></a>技术栈选择</h1><p>我简单分析了一下，发现busuanzi这个网页计数服务实现起来并不复杂，主要是通过获取访问请求的来源地址来实现PV和UV的计数增长，因此服务的核心就是一个统计接口。</p><p>基于这个分析，技术栈的选择也相对明确：</p><ol><li><p><strong>接口开发</strong>：由于我最熟悉Java，所以选择使用SpringBoot3和Java17来实现这个接口。（只实现一个接口的话，用SpringBoot感觉有些重，后续有时间可以考虑用Go重写一遍）</p></li><li><p><strong>数据存储</strong>：数据库选择很多，但考虑到服务需要记录的数据主要是网站的PV和UV，对于请求IP等信息并非必须存储，所以我选择使用Redis。Redis对于这类频繁操作的数据处理速度非常快，而且配置好Redis的持久化后，也不怎么需要担心数据丢失问题。如果还是不太放心，可以在增加一个定时任务，定时从Redis中读取数据，存储到关系型数据库当中去，但是我感觉没有必要。</p></li></ol><h1 id="服务分析"><a href="#服务分析" class="headerlink" title="服务分析"></a>服务分析</h1><h2 id="前端脚本"><a href="#前端脚本" class="headerlink" title="前端脚本"></a>前端脚本</h2><p>为了避免修改<code>Butterfly</code>主题中集成busuanzi的代码（以免在后续主题升级时进行频繁修改），需要让自建服务的接口访问方式和数据显示方式与原版busuanzi完全一致。因此，首先需要分析当前busuanzi的具体工作流程。</p><p>访问官网，可以看到官网提示的信息，只需要两行代码即可搞定计数。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;script <span class="keyword">async</span> src=<span class="string">&quot;//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">&quot;busuanzi_container_site_pv&quot;</span>&gt;</span>本站总访问量<span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">&quot;busuanzi_value_site_pv&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span>次<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>从这两行代码可以看出，busuanzi通过引入<code>busuanzi.pure.mini.js</code>脚本来修改<code>busuanzi_container_site_pv</code>标签的内容，从而实现计数显示。数据获取流程的核心就在这个脚本中。由于该脚本经过了代码压缩，我使用<code>claude code</code>对其进行了脚本还原，以提高代码可读性。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Busuanzi 不蒜子统计脚本</span></span><br><span class="line"><span class="comment"> * 用于网站PV/UV统计显示</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> bszCaller, bszTag;</span><br><span class="line"><span class="comment">// DOM Ready 功能实现</span></span><br><span class="line">(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> interval, </span><br><span class="line">        domReadyCallback, </span><br><span class="line">        executeCallbacks,</span><br><span class="line">        isReady = <span class="literal">false</span>, </span><br><span class="line">        readyCallbacks = [];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加ready回调函数</span></span><br><span class="line">    ready = <span class="keyword">function</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isReady || <span class="variable language_">document</span>.<span class="property">readyState</span> === <span class="string">&quot;interactive&quot;</span> || <span class="variable language_">document</span>.<span class="property">readyState</span> === <span class="string">&quot;complete&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> callback.<span class="title function_">call</span>(<span class="variable language_">document</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            readyCallbacks.<span class="title function_">push</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> callback.<span class="title function_">call</span>(<span class="variable language_">this</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行所有等待的回调函数</span></span><br><span class="line">    executeCallbacks = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, length = readyCallbacks.<span class="property">length</span>; i &lt; length; i++) &#123;</span><br><span class="line">            readyCallbacks[i].<span class="title function_">apply</span>(<span class="variable language_">document</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        readyCallbacks = [];</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// DOM准备完成后的处理</span></span><br><span class="line">    domReadyCallback = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isReady) &#123;</span><br><span class="line">            isReady = <span class="literal">true</span>;</span><br><span class="line">            executeCallbacks.<span class="title function_">call</span>(<span class="variable language_">window</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 移除事件监听器</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">document</span>.<span class="property">removeEventListener</span>) &#123;</span><br><span class="line">                <span class="variable language_">document</span>.<span class="title function_">removeEventListener</span>(<span class="string">&quot;DOMContentLoaded&quot;</span>, domReadyCallback, <span class="literal">false</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable language_">document</span>.<span class="property">attachEvent</span>) &#123;</span><br><span class="line">                <span class="variable language_">document</span>.<span class="title function_">detachEvent</span>(<span class="string">&quot;onreadystatechange&quot;</span>, domReadyCallback);</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable language_">window</span> == <span class="variable language_">window</span>.<span class="property">top</span>) &#123;</span><br><span class="line">                    <span class="built_in">clearInterval</span>(interval);</span><br><span class="line">                    interval = <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 绑定DOM Ready事件</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">document</span>.<span class="property">addEventListener</span>) &#123;</span><br><span class="line">        <span class="comment">// 现代浏览器</span></span><br><span class="line">        <span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;DOMContentLoaded&quot;</span>, domReadyCallback, <span class="literal">false</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable language_">document</span>.<span class="property">attachEvent</span>) &#123;</span><br><span class="line">        <span class="comment">// IE浏览器兼容</span></span><br><span class="line">        <span class="variable language_">document</span>.<span class="title function_">attachEvent</span>(<span class="string">&quot;onreadystatechange&quot;</span>, <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="regexp">/loaded|complete/</span>.<span class="title function_">test</span>(<span class="variable language_">document</span>.<span class="property">readyState</span>)) &#123;</span><br><span class="line">                <span class="title function_">domReadyCallback</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// IE浏览器特殊处理</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">window</span> == <span class="variable language_">window</span>.<span class="property">top</span>) &#123;</span><br><span class="line">            interval = <span class="built_in">setInterval</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!isReady) &#123;</span><br><span class="line">                        <span class="variable language_">document</span>.<span class="property">documentElement</span>.<span class="title function_">doScroll</span>(<span class="string">&quot;left&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="title function_">domReadyCallback</span>();</span><br><span class="line">            &#125;, <span class="number">5</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line"><span class="comment">// JSONP 调用器对象</span></span><br><span class="line">bszCaller = &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发起JSONP请求获取统计数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &#123;<span class="type">string</span>&#125; <span class="variable">url</span> - 请求URL</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &#123;<span class="type">function</span>&#125; <span class="variable">callback</span> - 回调函数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="attr">fetch</span>: <span class="keyword">function</span>(<span class="params">url, callback</span>) &#123;</span><br><span class="line">        <span class="comment">// 生成随机回调函数名</span></span><br><span class="line">        <span class="keyword">var</span> callbackName = <span class="string">&quot;BusuanziCallback_&quot;</span> + <span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">1099511627776</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 在全局作用域中注册回调函数</span></span><br><span class="line">        <span class="variable language_">window</span>[callbackName] = <span class="variable language_">this</span>.<span class="title function_">evalCall</span>(callback);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 替换URL中的回调函数名</span></span><br><span class="line">        url = url.<span class="title function_">replace</span>(<span class="string">&quot;=BusuanziCallback&quot;</span>, <span class="string">&quot;=&quot;</span> + callbackName);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 创建script标签进行JSONP请求</span></span><br><span class="line">        <span class="keyword">var</span> scriptTag = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;SCRIPT&quot;</span>);</span><br><span class="line">        scriptTag.<span class="property">type</span> = <span class="string">&quot;text/javascript&quot;</span>;</span><br><span class="line">        scriptTag.<span class="property">defer</span> = <span class="literal">true</span>;</span><br><span class="line">        scriptTag.<span class="property">src</span> = url;</span><br><span class="line">        scriptTag.<span class="property">referrerPolicy</span> = <span class="string">&quot;no-referrer-when-downgrade&quot;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 将script标签添加到head中</span></span><br><span class="line">        <span class="variable language_">document</span>.<span class="title function_">getElementsByTagName</span>(<span class="string">&quot;HEAD&quot;</span>)[<span class="number">0</span>].<span class="title function_">appendChild</span>(scriptTag);</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 包装回调函数，添加错误处理</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &#123;<span class="type">function</span>&#125; <span class="variable">callback</span> - 原始回调函数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@returns</span> &#123;<span class="type">function</span>&#125; 包装后的回调函数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="attr">evalCall</span>: <span class="keyword">function</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params">data</span>) &#123;</span><br><span class="line">            <span class="title function_">ready</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 执行回调并清理script标签</span></span><br><span class="line">                    <span class="title function_">callback</span>(data);</span><br><span class="line">                    <span class="keyword">if</span> (scriptTag &amp;&amp; scriptTag.<span class="property">parentElement</span>) &#123;</span><br><span class="line">                        scriptTag.<span class="property">parentElement</span>.<span class="title function_">removeChild</span>(scriptTag);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">                    <span class="comment">// 出错时隐藏统计显示</span></span><br><span class="line">                    bszTag.<span class="title function_">hides</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发起统计数据请求</span></span><br><span class="line">bszCaller.<span class="title function_">fetch</span>(<span class="string">&quot;//busuanzi.ibruce.info/busuanzi?jsonpCallback=BusuanziCallback&quot;</span>, <span class="keyword">function</span>(<span class="params">data</span>) &#123;</span><br><span class="line">    <span class="comment">// 更新页面统计数据并显示</span></span><br><span class="line">    bszTag.<span class="title function_">texts</span>(data);</span><br><span class="line">    bszTag.<span class="title function_">shows</span>();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 页面标签操作对象</span></span><br><span class="line">bszTag = &#123;</span><br><span class="line">    <span class="comment">// 支持的统计类型</span></span><br><span class="line">    <span class="attr">bszs</span>: [<span class="string">&quot;site_pv&quot;</span>, <span class="string">&quot;page_pv&quot;</span>, <span class="string">&quot;site_uv&quot;</span>],</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 更新页面中的统计数字</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &#123;<span class="type">object</span>&#125; <span class="variable">data</span> - 包含统计数据的对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="attr">texts</span>: <span class="keyword">function</span>(<span class="params">data</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">bszs</span>.<span class="title function_">map</span>(<span class="keyword">function</span>(<span class="params">type</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> element = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;busuanzi_value_&quot;</span> + type);</span><br><span class="line">            <span class="keyword">if</span> (element) &#123;</span><br><span class="line">                element.<span class="property">innerHTML</span> = data[type];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 隐藏所有统计容器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="attr">hides</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">bszs</span>.<span class="title function_">map</span>(<span class="keyword">function</span>(<span class="params">type</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> container = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;busuanzi_container_&quot;</span> + type);</span><br><span class="line">            <span class="keyword">if</span> (container) &#123;</span><br><span class="line">                container.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&quot;none&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 显示所有统计容器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="attr">shows</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">bszs</span>.<span class="title function_">map</span>(<span class="keyword">function</span>(<span class="params">type</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> container = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;busuanzi_container_&quot;</span> + type);</span><br><span class="line">            <span class="keyword">if</span> (container) &#123;</span><br><span class="line">                container.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&quot;inline&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>虽然对JavaScript不是很熟悉，但这个脚本逻辑相对清晰，不难读懂。以下是该脚本的核心工作流程：</p><ol><li>等待浏览器DOM准备</li><li>DOM准备完成后，发起JSONP请求</li><li>解析请求返回的标签数据，如果请求错误，数据异常就隐藏所有统计容器</li><li>获取到计数的数据后，更新携带有ID为<code>busuanzi_value_</code>或<code>busuanzi_container_</code>统计标签的数据，然后修改容器的<code>display</code>属性，从而实现容器和内容的显示</li></ol><blockquote><p>JSONP其实就是GET请求，主要是利用<code>&lt;script&gt;</code>标签可以跨域加载资源的特性，将数据请求伪装成脚本加载，服务器返回的也不是纯数据，而是一个函数调用，从而绕过浏览器的同源策略限制。</p></blockquote><p>前端操作通过这个简单的脚本即可实现，接下来分析后端接口的实现方式。</p><h2 id="后端接口"><a href="#后端接口" class="headerlink" title="后端接口"></a>后端接口</h2><p>网页计数服务的核心功能是记录URL的UV和PV数据。这些指标又分为站点级别和页面级别，理论上应该有四个数据（但busuanzi不计算页面UV，因此只有三个），这里按四个指标数据计算。下面逐一分析这些数据的计算方法。</p><h3 id="PV"><a href="#PV" class="headerlink" title="PV"></a>PV</h3><p>PV，即浏览量，根据定义也不难知道计算的方法。当前端访问接口的时候，站点浏览量进行加1，页面浏览量进行加1既可以获得这两个PV数据量。</p><p>那么后端接口如何获知是哪个页面发起的请求呢？回头查看busuanzi脚本并未发现页面的相关信息，因此需要观察busuanzi脚本发送的具体HTTP请求信息。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">curl ^&quot;https://busuanzi.ibruce.info/busuanzi?jsonpCallback=BusuanziCallback_12592539439^&quot; ^</span><br><span class="line">  -H ^&quot;accept: */*^&quot; ^</span><br><span class="line">  -H ^&quot;accept-language: zh-CN,zh;q=0.9^&quot; ^</span><br><span class="line">  -H ^&quot;referer: https://yww52.com/^&quot; ^</span><br><span class="line">  -H ^&quot;sec-ch-ua: ^\^&quot;Not;A=Brand^\^&quot;;v=^\^&quot;99^\^&quot;, ^\^&quot;Google Chrome^\^&quot;;v=^\^&quot;139^\^&quot;, ^\^&quot;Chromium^\^&quot;;v=^\^&quot;139^\^&quot;^&quot; ^</span><br><span class="line">  -H ^&quot;sec-ch-ua-mobile: ?0^&quot; ^</span><br><span class="line">  -H ^&quot;sec-ch-ua-platform: ^\^&quot;Windows^\^&quot;^&quot; ^</span><br><span class="line">  -H ^&quot;sec-fetch-dest: script^&quot; ^</span><br><span class="line">  -H ^&quot;sec-fetch-mode: no-cors^&quot; ^</span><br><span class="line">  -H ^&quot;sec-fetch-site: cross-site^&quot; ^</span><br><span class="line">  -H ^&quot;sec-fetch-storage-access: active^&quot; ^</span><br><span class="line">  -H ^&quot;user-agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.0.0 Safari/537.36^&quot;</span><br></pre></td></tr></table></figure><p>经过仔细观察，容易发现请求头中的<code>referer</code>字段记录了当前页面的信息。切换到不同页面时，该字段也会相应变为相应页面的URL。基于这个信息，就可以计算出所需的两个PV数据：</p><ol><li><strong>site_pv</strong>（站点浏览量）：从<code>referer</code>请求头中提取站点Host地址，在Redis中存储一个键值对，并对该值进行递增操作</li><li><strong>page_pv</strong>（页面浏览量）：直接使用<code>referer</code>请求头信息作为键，在Redis中存储键值对，并对该值进行递增操作</li></ol><h3 id="UV"><a href="#UV" class="headerlink" title="UV"></a>UV</h3><p>UV（独立访客数）的统计重点在于两个关键概念：<code>每日</code>和<code>独立访客</code>。</p><p>对于每日统计，除了存储UV值外，还需要维护一个当日访客集合。当新请求到达时，通过查询该集合可以判断当前访客今日是否已经访问过。若已访问，则UV数据保持不变；若为首次访问，则UV数据递增。</p><p>独立访客的识别相对复杂，因为Hexo博客是纯静态页面，难以直接区分不同访客。前面的请求脚本中也未发现访客标识相关数据，于是我推测访客信息应该记录在HTTP请求中。为了对标busuanzi的实现机制，需要进一步分析具体请求。最好重新打开浏览器或清理缓存，以观察UV增长时的请求响应信息。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">content-length 109</span><br><span class="line">content-type application/json</span><br><span class="line">date Sun, 10 Aug 2025 07:55:37 GMT</span><br><span class="line">server nginx/1.14.1</span><br><span class="line">set-cookie busuanziId=8CBB7C5BBCF54C86B90DAD230C7B5275; Path=/; httponly; secure; SameSite=None; Domain=busuanzi.ibruce.info; Secure</span><br></pre></td></tr></table></figure><p>从响应请求头可以看出，busuanzi采用了浏览器Cookie机制来识别独立访客。服务端在响应中设置Cookie，浏览器会在后续请求中自动携带该Cookie。通过检测请求中是否包含Cookie，服务端可以判断是否为首次访问。基于这个机制，可以得出UV数据的计算方法：</p><ol><li><strong>site_uv</strong>（站点每日独立访客数）：从<code>referer</code>请求头获取站点Host地址。若请求不包含Cookie，则生成新Cookie并添加至当日站点访客集合，同时返回Cookie并将UV数据递增。若请求已携带Cookie，则不进行任何增长操作</li><li><strong>page_uv</strong>（页面每日独立访客数）：使用<code>referer</code>请求头信息作为页面标识。若请求不包含Cookie，则生成新Cookie并添加至当日页面访客集合，同时返回Cookie并将UV数据递增。若请求已携带Cookie，则不进行任何增长操作</li></ol><h1 id="服务实现"><a href="#服务实现" class="headerlink" title="服务实现"></a>服务实现</h1><h2 id="接口实现"><a href="#接口实现" class="headerlink" title="接口实现"></a>接口实现</h2><p>这里我先展示所有使用到的Redis的键和类型，方便后续查找修改。</p><p><code>host</code>表示站点地址，<code>url</code>表示资源地址，<code>date</code>表示日期。</p><div class="table-container"><table><thead><tr><th style="text-align:center">数据名称</th><th style="text-align:center">Redis键名</th><th style="text-align:center">Redis类型</th></tr></thead><tbody><tr><td style="text-align:center">site_pv（站点浏览量）</td><td style="text-align:center">pv:{host}</td><td style="text-align:center">string</td></tr><tr><td style="text-align:center">page_pv（页面浏览量）</td><td style="text-align:center">pv:page:{url}</td><td style="text-align:center">string</td></tr><tr><td style="text-align:center">site_uv（站点每日独立访客数）</td><td style="text-align:center">uv:{host}</td><td style="text-align:center">string</td></tr><tr><td style="text-align:center">每日站点访客数（缓存7天）</td><td style="text-align:center">uvtime:{date}:{host}</td><td style="text-align:center">set</td></tr><tr><td style="text-align:center">page_uv（页面每日独立访客数）</td><td style="text-align:center">uv:page:{url}</td><td style="text-align:center">string</td></tr><tr><td style="text-align:center">每日页面访客数（缓存7天）</td><td style="text-align:center">uvtime:page:{date}:{url}</td><td style="text-align:center">set</td></tr></tbody></table></div><blockquote><p>使用string和set这两种数据结构完全足够了，大部分博客不是什么高流量的网站，string结构的数据很好用而且也很准确，完全没必要使用hyperloglog，特别是数据量少的情况。</p></blockquote><p>关于具体的实现，服务分析当中已经写的很明白了，这个服务其实就是一个核心的请求接口，逻辑和代码我就不一一贴出来了，我已经上传到Github`上面了，感兴趣可以自行研究，附带一下仓库地址。</p><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jaslli/busuanzi">https://github.com/jaslli/busuanzi</a></p><h2 id="优化部分"><a href="#优化部分" class="headerlink" title="优化部分"></a>优化部分</h2><p>服务代码除了适配原有的busuanzi的<code>JSONP</code>请求外，还自行进行了一些优化。以下是我进行优化的方向：</p><ol><li>因为后端是自己编写的服务，所以不需要前端使用JSONP的方式进行跨域处理，所以直接使用<code>fetch</code>的GET请求即可。</li><li>原版busuanzi是使用了cookie进行用户管理，我改为了使用浏览器<code>localStorage</code>进行存储管理用户信息，这样数据更加可以精准。</li></ol><p>如果需要进行修改，那么前端的请求脚本也需要修改，我根据原有的脚本进行了简单的优化。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line">(function () &#123;</span><br><span class="line">    &#x27;use strict&#x27;;</span><br><span class="line"></span><br><span class="line">    // 配置项</span><br><span class="line">    const CONFIG = &#123;</span><br><span class="line">        // 统计项名称列表</span><br><span class="line">        STATISTICS: [&quot;site_pv&quot;, &quot;page_pv&quot;, &quot;site_uv&quot;, &quot;page_uv&quot;],</span><br><span class="line">        // API地址，请根据实际情况修改</span><br><span class="line">        API_URL: &quot;https://xxxx.com/busuanzi/api&quot;,</span><br><span class="line">        // localStorage中存储身份标识的key</span><br><span class="line">        LOCALSTORAGE_KEY: &quot;bsz-id&quot;,</span><br><span class="line">        // busuanzi的元素容器和元素值前缀</span><br><span class="line">        ITEM_VALUE_PREFIX: &quot;busuanzi_value_&quot;,</span><br><span class="line">        ITEM_CONTAINER_PREFIX: &quot;busuanzi_container_&quot;,</span><br><span class="line">        // 请求超时时间（毫秒）</span><br><span class="line">        REQUEST_TIMEOUT: 5000,</span><br><span class="line">        // 重试次数</span><br><span class="line">        RETRY_COUNT: 3</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * DOM Ready 检测函数</span><br><span class="line">     *</span><br><span class="line">     * @param &#123;Function&#125; callback - DOM准备完成后执行的回调函数</span><br><span class="line">     */</span><br><span class="line">    function domReady(callback) &#123;</span><br><span class="line">        if (document.readyState === &quot;loading&quot;) &#123;</span><br><span class="line">            document.addEventListener(&quot;DOMContentLoaded&quot;, callback, &#123; once: true &#125;);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            // DOM已经准备完成，立即执行</span><br><span class="line">            callback();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 创建带超时的fetch请求</span><br><span class="line">     *</span><br><span class="line">     * @param &#123;string&#125; url      请求URL</span><br><span class="line">     * @param &#123;object&#125; options  fetch选项</span><br><span class="line">     * @param &#123;number&#125; timeout  超时时间</span><br><span class="line">     * @returns &#123;Promise&#125;       fetch Promise</span><br><span class="line">     */</span><br><span class="line">    function fetchWithTimeout(url, options, timeout) &#123;</span><br><span class="line">        return Promise.race([</span><br><span class="line">            fetch(url, options),</span><br><span class="line">            new Promise((_, reject) =&gt;</span><br><span class="line">                setTimeout(() =&gt; reject(new Error(&#x27;Request timeout&#x27;)), timeout)</span><br><span class="line">            )</span><br><span class="line">        ]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 保存用户身份标识</span><br><span class="line">     * @param &#123;string&#125; userId - 用户身份标识</span><br><span class="line">     */</span><br><span class="line">    function saveUserId(userId) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            if (userId &amp;&amp; userId !== &quot;&quot;) &#123;</span><br><span class="line">                localStorage.setItem(CONFIG.LOCALSTORAGE_KEY, userId);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (error) &#123;</span><br><span class="line">            console.warn(&#x27;无法保存到localStorage:&#x27;, error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 获取或生成用户身份标识</span><br><span class="line">     * @returns &#123;string|null&#125; 用户身份标识</span><br><span class="line">     */</span><br><span class="line">    function getUserId() &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            return localStorage.getItem(CONFIG.LOCALSTORAGE_KEY);</span><br><span class="line">        &#125; catch (error) &#123;</span><br><span class="line">            console.warn(&#x27;无法访问localStorage:&#x27;, error);</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 隐藏所有统计容器（出错时调用）</span><br><span class="line">     */</span><br><span class="line">    function hideStatistics() &#123;</span><br><span class="line">        CONFIG.STATISTICS.forEach(item =&gt; &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                const containerElement = document.getElementById(CONFIG.ITEM_CONTAINER_PREFIX + item);</span><br><span class="line">                if (containerElement) &#123;</span><br><span class="line">                    containerElement.style.display = &quot;none&quot;;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; catch (error) &#123;</span><br><span class="line">                console.warn(`隐藏统计项 $&#123;item&#125; 时出错:`, error);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 发送统计请求</span><br><span class="line">     *</span><br><span class="line">     * @param &#123;number&#125; retryCount - 剩余重试次数</span><br><span class="line">     */</span><br><span class="line">    function fetchStatistics(retryCount = CONFIG.RETRY_COUNT) &#123;</span><br><span class="line">        // 构建请求头</span><br><span class="line">        const headers = new Headers();</span><br><span class="line">        headers.append(&quot;X-Referer&quot;, window.location.href);</span><br><span class="line"></span><br><span class="line">        const userId = getUserId();</span><br><span class="line">        if (userId) &#123;</span><br><span class="line">            headers.append(&quot;Authorization&quot;, userId);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 发送超时请求</span><br><span class="line">        fetchWithTimeout(CONFIG.API_URL, &#123;</span><br><span class="line">            method: &quot;GET&quot;,</span><br><span class="line">            headers: headers</span><br><span class="line">        &#125;, CONFIG.REQUEST_TIMEOUT)</span><br><span class="line">            // 请求成功处理</span><br><span class="line">            .then(response =&gt; &#123;</span><br><span class="line">                if (!response.ok) &#123;</span><br><span class="line">                    throw new Error(`HTTP error! status: $&#123;response.status&#125;`);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                // 保存响应头中的身份标识</span><br><span class="line">                const bszId = response.headers.get(&quot;Authorization&quot;);</span><br><span class="line">                if (bszId) &#123;</span><br><span class="line">                    saveUserId(bszId);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                return response.json();</span><br><span class="line">            &#125;)</span><br><span class="line">            // 成功数据处理</span><br><span class="line">            .then(data =&gt; &#123;</span><br><span class="line">                // 遍历每项统计数据，然后进行更改</span><br><span class="line">                CONFIG.STATISTICS.forEach(item =&gt; &#123;</span><br><span class="line">                    try &#123;</span><br><span class="line">                        // 更新统计数值</span><br><span class="line">                        const valueElement = document.getElementById(CONFIG.ITEM_VALUE_PREFIX + item);</span><br><span class="line">                        if (valueElement) &#123;</span><br><span class="line">                            valueElement.innerHTML = data[item] || 0;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        // 显示统计容器</span><br><span class="line">                        const containerElement = document.getElementById(CONFIG.ITEM_CONTAINER_PREFIX + item);</span><br><span class="line">                        if (containerElement) &#123;</span><br><span class="line">                            containerElement.style.display = &quot;inline&quot;;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; catch (error) &#123;</span><br><span class="line">                        console.warn(`更新统计项 $&#123;item&#125; 时出错:`, error);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;)</span><br><span class="line">            .catch(error =&gt; &#123;</span><br><span class="line">                console.error(&#x27;busuanzi统计请求失败:&#x27;, error);</span><br><span class="line"></span><br><span class="line">                // 重试机制</span><br><span class="line">                if (retryCount &gt; 0) &#123;</span><br><span class="line">                    console.log(`正在重试... 剩余重试次数: $&#123;retryCount&#125;`);</span><br><span class="line">                    setTimeout(() =&gt; &#123;</span><br><span class="line">                        fetchStatistics(retryCount - 1);</span><br><span class="line">                    &#125;, 1000); // 1秒后重试</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    console.error(&#x27;所有重试都失败，隐藏统计显示&#x27;);</span><br><span class="line">                    hideStatistics();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 等待DOM准备完成后初始化</span><br><span class="line">    domReady(fetchStatistics);</span><br><span class="line"></span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure><h1 id="服务部署"><a href="#服务部署" class="headerlink" title="服务部署"></a>服务部署</h1><p>这次涉及的服务有两个，一个是<code>SpringBoot</code>的Java服务，一个是<code>Redis</code>服务，如果是要部署的话，就需要分开部署。</p><p>这里我使用了<code>docker-compose</code>来进行部署，也可以更加方便，以下是三个所需的配置文件。</p><ol><li><p>服务的Dockerfile</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> eclipse-temurin:<span class="number">17</span>-jre-alpine</span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> maintainer=<span class="string">&quot;yww@yww52.com&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置时区</span></span><br><span class="line"><span class="keyword">ENV</span> TZ=Asia/Shanghai</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apk add tzdata \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">ln</span> -snf /usr/share/zoneinfo/<span class="variable">$TZ</span> /etc/localtime \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">echo</span> <span class="variable">$TZ</span> &gt; /etc/timezone \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; apk del tzdata \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">rm</span> -rf /var/cache/apk/*</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义应用相关环境变量</span></span><br><span class="line"><span class="keyword">ENV</span> JAVA_OPTS=<span class="string">&quot;-Xms512m -Xmx2048m -Xmn614m -Xss256k -XX:SurvivorRatio=6 -XX:+UseG1GC -XX:MetaspaceSize=256m -XX:MaxMetaspaceSize=512m&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> APP_HOME=/app</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建非root用户并设置权限</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> adduser -D appuser &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">mkdir</span> -p <span class="variable">$APP_HOME</span> &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">chown</span> -R appuser:appuser <span class="variable">$APP_HOME</span></span></span><br><span class="line"><span class="keyword">USER</span> appuser</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置工作目录和应用目录</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> <span class="variable">$APP_HOME</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制已打包的 JAR 文件</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> busuanzi-1.0.jar <span class="variable">$APP_HOME</span>/app.jar</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 暴露应用端口</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">10010</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动命令（使用环境变量配置 JVM 参数）</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;java <span class="variable">$JAVA_OPTS</span> -jar app.jar&quot;</span>]</span></span><br></pre></td></tr></table></figure></li><li><p>redis的配置文件，这里的路径是容器内的路径，尽量不要修改</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">dir /data/redis</span><br><span class="line">bind 0.0.0.0</span><br><span class="line">port 6379</span><br><span class="line"></span><br><span class="line"># 日志文件存放</span><br><span class="line">logfile &quot;/data/log/redis.log&quot;</span><br><span class="line"></span><br><span class="line"># 启用AOF持久化</span><br><span class="line">appendonly yes</span><br><span class="line">appendfilename &quot;appendonly.aof&quot;</span><br><span class="line">appendfsync everysec</span><br><span class="line"></span><br><span class="line"># RDB持久化配置（可选）</span><br><span class="line">save 900 1</span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br><span class="line"></span><br><span class="line"># 日志级别</span><br><span class="line">loglevel notice</span><br></pre></td></tr></table></figure></li><li><p>服务编排文件<code>docker-compose.yml</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="comment"># 这个名字修改了，下面依赖服务名也要修改，springboot配置文件Redis连接服务名也要修改</span></span><br><span class="line">  <span class="attr">busuanzi-redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis:7-alpine</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">busuanzi-redis</span></span><br><span class="line">    <span class="comment"># 可自行修改宿主机端口，同一个网络服务是联通的，不映射端口直接删除没有影响</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;16379:6379&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="comment"># 持久化数据目录映射到宿主机</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/data/docker/busuanzi/data:/data/redis</span></span><br><span class="line">      <span class="comment"># 日志映射到宿主机</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/data/docker/busuanzi/log:/data/log</span></span><br><span class="line">      <span class="comment"># Redis配置文件映射到宿主机</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/data/docker/busuanzi/redis.conf:/usr/local/etc/redis/redis.conf</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">redis-server</span> <span class="string">/usr/local/etc/redis/redis.conf</span> <span class="string">--appendonly</span> <span class="literal">yes</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">busuanzi-network</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">busuanzi:</span></span><br><span class="line">    <span class="attr">build:</span> </span><br><span class="line">      <span class="attr">context:</span> <span class="string">.</span></span><br><span class="line">      <span class="attr">dockerfile:</span> <span class="string">Dockerfile</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">busuanzi</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;10010:10010&quot;</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">busuanzi-redis</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">busuanzi-network</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">busuanzi-network:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br></pre></td></tr></table></figure></li></ol><p>将上述三个配置文件和springboot打包生成的jar包放在一个文件夹中，然后执行<code>docker-compose up -d</code>即可运行整个编排服务。</p><p>服务部署好后，自行使用nginx进行反向代理，推荐使用<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.lxware.cn/">1panel</a>,里面的网站部署使用了<code>OpenResty</code>，直接创建一个反向代理即可。如果安装了<code>1panel</code>，docker相关环境基本全部自动安装好，无需自己手动在安装环境，可以一步到位。</p><h1 id="busuanzi数据迁移"><a href="#busuanzi数据迁移" class="headerlink" title="busuanzi数据迁移"></a>busuanzi数据迁移</h1><p>不太想放弃原有的busuanzi数据，可以直接将原有的busuanzi数据迁移到服务部署的redis当中，我讲一下比较简单的一个流程。</p><ol><li>获取当前站点的sitemap</li><li>然后根据sitemap获取到站点所有的页面URL</li><li>然后根据每个页面的URL去请求原有的busuanzi接口</li><li>将得到的数据设置到服务的Redis当中即可</li></ol><p>Java代码如下。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">FileUtil.writeBytes(file.getBytes(), filePath);</span><br><span class="line">List&lt;String&gt; links = SitemapUtil.parseSitemapXml(filePath);</span><br><span class="line">links.forEach(link -&gt; &#123;</span><br><span class="line"><span class="type">String</span> <span class="variable">api</span> <span class="operator">=</span> <span class="string">&quot;https://busuanzi.ibruce.info/busuanzi&quot;</span>;</span><br><span class="line"><span class="meta">@Cleanup</span></span><br><span class="line"><span class="type">HttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> HttpUtil.createGet(api)</span><br><span class="line">        .header(<span class="string">&quot;Referer&quot;</span>, link)</span><br><span class="line">        .form(<span class="string">&quot;jsonpCallback&quot;</span>, <span class="string">&quot;BusuanziCallback_921338913213&quot;</span>)</span><br><span class="line">        .execute();</span><br><span class="line"><span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> response.body();</span><br><span class="line"><span class="type">String</span> <span class="variable">host</span> <span class="operator">=</span> URLUtil.getHost(link);</span><br><span class="line"><span class="comment">// 截取script脚本中的数据</span></span><br><span class="line"><span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> JSON.parseObject(body.substring(body.indexOf(<span class="string">&#x27;&#123;&#x27;</span>, <span class="number">4</span>), body.indexOf(<span class="string">&#x27;&#125;&#x27;</span>) + <span class="number">1</span>));</span><br><span class="line">redisCache.add(<span class="string">&quot;pv:&quot;</span> + host, jsonObject.getString(<span class="string">&quot;site_pv&quot;</span>));</span><br><span class="line">redisCache.add(<span class="string">&quot;pv:page:&quot;</span> + link, jsonObject.getString(<span class="string">&quot;page_pv&quot;</span>));</span><br><span class="line">redisCache.add(<span class="string">&quot;uv:&quot;</span> + host, jsonObject.getString(<span class="string">&quot;site_uv&quot;</span>));</span><br><span class="line"><span class="comment">// 避免出现限流等情况，缓一缓</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    Thread.sleep(<span class="number">200</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">&#125;</span><br><span class="line">log.info(<span class="string">&quot;成功初始化url【&#123;&#125;】的数据&quot;</span>, link);</span><br></pre></td></tr></table></figure></article><div class="tag_share"><div class="post-share"><div class="social-share" data-image="https://img.yww52.com/2025/8/2025-8-10top_img.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/butterfly-extsrc/1.1.4/sharejs/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdnjs.cloudflare.com/ajax/libs/butterfly-extsrc/1.1.4/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related full-width" href="/posts/91f4854c/" title="Java图片处理"><img class="cover" src= "https://img.yww52.com/source/image/404.jpg" data-lazy-src="https://img.yww52.com/2023/4/2023-4-18top_img.jpg" onerror='onerror=null,src="https://img.yww52.com/source/image/404.jpg"' alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">Java图片处理</div></div><div class="info-2"><div class="info-item-1">最近经常接触Java的图片处理，所以特地来记录一下。</div></div></div></a></nav><hr class="custom-hr"><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="artalk-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%8A%80%E6%9C%AF%E6%A0%88%E9%80%89%E6%8B%A9"><span class="toc-number">2.</span> <span class="toc-text">技术栈选择</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%88%86%E6%9E%90"><span class="toc-number">3.</span> <span class="toc-text">服务分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%E8%84%9A%E6%9C%AC"><span class="toc-number">3.1.</span> <span class="toc-text">前端脚本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8E%E7%AB%AF%E6%8E%A5%E5%8F%A3"><span class="toc-number">3.2.</span> <span class="toc-text">后端接口</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PV"><span class="toc-number">3.2.1.</span> <span class="toc-text">PV</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UV"><span class="toc-number">3.2.2.</span> <span class="toc-text">UV</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%AE%9E%E7%8E%B0"><span class="toc-number">4.</span> <span class="toc-text">服务实现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%AE%9E%E7%8E%B0"><span class="toc-number">4.1.</span> <span class="toc-text">接口实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E9%83%A8%E5%88%86"><span class="toc-number">4.2.</span> <span class="toc-text">优化部分</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E9%83%A8%E7%BD%B2"><span class="toc-number">5.</span> <span class="toc-text">服务部署</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#busuanzi%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB"><span class="toc-number">6.</span> <span class="toc-text">busuanzi数据迁移</span></a></li></ol></div></div></div></div></main><footer id="footer" style="background-image:url(https://img.yww52.com/source/index_img/footer.jpg)"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;2019 - 2025 By yww</span><span class="framework-info"><span>框架 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.4.2</a></span></div><div class="footer_custom_text"><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.upyun.com/?utm_source=lianmeng&amp;utm_medium=referra">又拍云</a><span>提供加速服务</span><br><a id="yww-beian" target="_blank" rel="noopener external nofollow noreferrer" href="https://beian.miit.gov.cn"><span>桂ICP备20005765号</span></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/6.0.7/fancybox/fancybox.umd.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/instant.page/5.2.0/instantpage.min.js" type="module"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/19.1.3/lazyload.iife.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/node-snackbar/0.1.16/snackbar.min.js"></script><div class="js-pjax"><script>(()=>{let o=null,a=null,l="shuoshuo"===GLOBAL_CONFIG_SITE.pageType,n=()=>{o&&(o.destroy(),o=null)},r=t=>o&&o.setDarkMode("dark"===t),d=(t=document,e=location.pathname)=>{o=Artalk.init({el:t.querySelector("#artalk-wrap"),server:"https://blog.yww52.com",site:"yww的博客",darkMode:"dark"===document.documentElement.getAttribute("data-theme"),...a,pageKey:!l&&a&&a.pageKey||e}),"null"!==GLOBAL_CONFIG.lightbox&&(o.on("list-loaded",()=>{o.ctx.get("list").getCommentNodes().forEach(t=>{t=t.getRender().$content;btf.loadLightbox(t.querySelectorAll("img:not([atk-emoticon])"))})}),l&&(window.shuoshuoComment.destroyArtalk=()=>{n(),t.children.length&&(t.innerHTML="",t.classList.add("no-comment"))}),btf.addGlobalFn("pjaxSendOnce",n,"destroyArtalk"),btf.addGlobalFn("themeChange",r,"artalk"))};var t=async(t,e)=>{"object"==typeof Artalk||(await btf.getCSS("https://img.yww52.com/source/css/artalk.min.css"),await btf.getScript("https://img.yww52.com/source/scripts/artalk.min.js")),d(t,e)};l?window.shuoshuoComment={loadComment:t}:btf.loadComment(document.getElementById("artalk-wrap"),t)})()</script></div><script>window.newestComments={changeContent:e=>e=""!==e&&150<(e=(e=(e=(e=(e=e.replace(/<img.*?src="(.*?)"?[^\>]+>/gi,"[图片]")).replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi,"[链接]")).replace(/<pre><code>.*?<\/pre>/gi,"[代码]")).replace(/<code>.*?<\/code>/gi,"[代码]")).replace(/<[^>]+>/g,"")).length?e.substring(0,150)+"...":e,generateHtml:(t,e)=>{let a="";if(t.length)for(let e=0;e<t.length;e++)a+='<div class="aside-list-item">',t[e].avatar&&(a+=`<a href="${t[e].url}" class="thumbnail"><img data-lazy-src="${t[e].avatar}" alt="${t[e].nick}" ${""}></a>`),a+=`<div class="content">
        <a class="comment" href="${t[e].url}" title="${t[e].content}">${t[e].content}</a>
        <div class="name"><span>${t[e].nick} / </span><time datetime="${t[e].date}">${btf.diffDate(t[e].date,!0)}</time></div>
        </div></div>`;else a+="暂无评论";e.innerHTML=a,window.lazyLoadInstance&&window.lazyLoadInstance.update(),window.pjax&&window.pjax.refresh(e)},newestCommentInit:(e,t)=>{var a=document.querySelector("#card-newest-comments .aside-list");a&&((e=btf.saveToLocal.get(e))?newestComments.generateHtml(JSON.parse(e),a):t(a))},run:(e,t)=>{newestComments.newestCommentInit(e,t),btf.addGlobalFn("pjaxComplete",()=>newestComments.newestCommentInit(e,t),e)}}</script><script>window.addEventListener("load",()=>{let o="artalk-newest-comments",{changeContent:s,generateHtml:c,run:a}=window.newestComments,i=new URLSearchParams({site_name:"yww的博客",limit:"12"});a(o,async n=>{try{var a=await(await fetch("https://blog.yww52.com/api/v2/stats/latest_comments?"+i)).json();let{avatarCdn:t,avatarDefault:e}=await(async()=>{var t=a=>a.startsWith("d=")?a:"d="+a;try{var{mirror:a,params:e,default:n}=(await(await fetch("https://blog.yww52.com/api/v2/conf")).json()).frontend_conf.gravatar;return{avatarCdn:a,avatarDefault:t(e||n)}}catch(a){return console.error(a),{avatarCdn:"",avatarDefault:t("")}}})();var r=a.data.filter(a=>!a.is_pending).slice(0,6).map(a=>({avatar:t&&a.email_encrypted?""+t+a.email_encrypted+"?"+e:"",content:s(a.content_marked),nick:a.nick,url:a.page_url,date:a.date}));btf.saveToLocal.set(o,JSON.stringify(r),10/1440),c(r,n)}catch(a){console.log(a),n.textContent="无法获取评论，请确认相关配置是否正确"}})})</script><link rel="stylesheet" href="/yww/optimize.css"><script async data-pjax src="/yww/optimize.js"></script><link rel="stylesheet" href="https://img.yww52.com/source/css/iconfont.min.css"><script src="https://cdnjs.cloudflare.com/ajax/libs/pjax/0.2.8/pjax.min.js"></script><script>(()=>{window.pjax=new Pjax({elements:'a:not([target="_blank"])',selectors:["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"],cacheBust:!1,analytics:!1,scrollRestoration:!1});let t=e=>{e&&Object.values(e).forEach(e=>e())};document.addEventListener("pjax:send",()=>{btf.removeGlobalFnEvent("pjaxSendOnce"),btf.removeGlobalFnEvent("themeChange");var e=document.body.classList;e.contains("read-mode")&&e.remove("read-mode"),t(window.globalFn.pjaxSend)}),document.addEventListener("pjax:complete",()=>{btf.removeGlobalFnEvent("pjaxCompleteOnce"),document.querySelectorAll("script[data-pjax]").forEach(e=>{let t=document.createElement("script");var a=e.text||e.textContent||e.innerHTML||"";Array.from(e.attributes).forEach(e=>t.setAttribute(e.name,e.value)),t.appendChild(document.createTextNode(a)),e.parentNode.replaceChild(t,e)}),t(window.globalFn.pjaxComplete)}),document.addEventListener("pjax:error",e=>{404===e.request.status&&pjax.loadUrl("/404.html")})})()</script><script async data-pjax src="/yww/busuanzi.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span> 数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div><script data-pjax src="https://img.yww52.com/source/scripts/live2d.min.js"></script><script>let oml2d=OML2D.loadOml2d({dockedPosition:"left",mobileDisplay:!1,parentElement:document.body,primaryColor:"#d0c3fc",sayHello:!0,models:[{path:"https://img.yww52.com/live2d-models/muluan/86.model3.json",name:"慕鸾",position:[-330,-110],scale:.26,stageStyle:{width:260,height:300},mobilePosition:[-10,23],mobileScale:.1,mobileStageStyle:{width:180,height:166},motionPreloadStrategy:"ALL"},{path:"https://img.yww52.com/live2d-models/muluan-hunfu/116.model3.json",name:"慕鸾婚服",position:[-250,-80],scale:.2,stageStyle:{width:260,height:300},mobilePosition:[-10,23],mobileScale:.1,mobileStageStyle:{width:180,height:166},motionPreloadStrategy:"ALL"},{path:"https://img.yww52.com/live2d-models/muluan-angel/qc.model3.json",name:"小天使慕鸾",position:[-100,-30],scale:.15,stageStyle:{width:260,height:300},mobilePosition:[-10,23],mobileScale:.1,mobileStageStyle:{width:180,height:166},motionPreloadStrategy:"ALL"}],menus:{disable:!1},tips:{style:{width:200,height:110,left:"calc(50% - 20px)",top:"-130px"},mobileStyle:{width:180,height:80,left:"calc(50% - 30px)",top:"-100px"},idleTips:{interval:15e3,message:["你好呀~","欢迎来到我的小站~"]}},statusBar:{disable:!1}})</script></body></html>